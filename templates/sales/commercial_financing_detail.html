{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">ğŸ“‹ DÃ©tails de la Demande de Financement</h2>

  <div class="row">
    <!-- Informations du client -->
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸ‘¤ Informations du Client</h5>
        </div>
        <div class="card-body">
          <p><strong>Nom :</strong> {{ client.prenom }} {{ client.nom }}</p>
          <p><strong>Email :</strong> {{ client.email }}</p>
          <p><strong>TÃ©lÃ©phone :</strong> {{ client.telephone }}</p>
          <p><strong>Statut KYC :</strong> {{ client.kyc_statut|default:"Non renseignÃ©" }}</p>
        </div>
      </div>
    </div>

    <!-- Informations de la rÃ©servation -->
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">ğŸ˜ï¸ UnitÃ© RÃ©servÃ©e</h5>
        </div>
        <div class="card-body">
          <p><strong>RÃ©fÃ©rence :</strong> {{ unite.reference }}</p>
          <p><strong>Programme :</strong> {{ unite.programme.nom }}</p>
          <p><strong>Type :</strong> {{ unite.type_bien.libelle }}</p>
          <p><strong>Prix TTC :</strong> {{ unite.prix_ttc|floatformat:0 }} FCFA</p>
          <p><strong>Acompte versÃ© :</strong> {{ reservation.acompte|floatformat:0 }} FCFA</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- DÃ©tails du financement -->
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">ğŸ’° Demande de Financement</h5>
        </div>
        <div class="card-body">
          <p><strong>Banque :</strong> {{ banque.nom }}</p>
          <p><strong>Code banque :</strong> {{ banque.code_banque }}</p>
          <p><strong>Contact :</strong> {{ banque.contact }}</p>
          <hr>
          <p><strong>Montant demandÃ© :</strong> <span class="display-6 text-warning fw-bold">{{ financement.montant|floatformat:0 }} FCFA</span></p>
          <p><strong>Type :</strong> {{ financement.type }}</p>
          <p><strong>Date de demande :</strong> {{ financement.created_at|date:"d/m/Y H:i" }}</p>
        </div>
      </div>
    </div>

    <!-- Statut actuel et actions -->
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">ğŸ“Š Statut de la Demande</h5>
        </div>
        <div class="card-body">
          <p class="mb-3">
            <strong>Statut actuel :</strong><br>
            {% if financement.statut == 'soumis' %}
              <span class="badge bg-info p-2">ğŸ“® Soumis</span>
            {% elif financement.statut == 'en_etude' %}
              <span class="badge bg-warning text-dark p-2">ğŸ“š En Ã©tude</span>
            {% elif financement.statut == 'accepte' %}
              <span class="badge bg-success p-2">âœ… AcceptÃ©</span>
            {% elif financement.statut == 'refuse' %}
              <span class="badge bg-danger p-2">âŒ RefusÃ©</span>
            {% elif financement.statut == 'clos' %}
              <span class="badge bg-secondary p-2">ğŸ Clos</span>
            {% endif %}
          </p>

          <!-- Formulaire de changement de statut -->
          <form method="post">
            {% csrf_token %}
            <div class="mb-3">
              <label for="statut" class="form-label"><strong>Changer le statut :</strong></label>
              <select name="statut" id="statut" class="form-select" required>
                <option value="">-- SÃ©lectionnez un statut --</option>
                <option value="soumis" {% if financement.statut == 'soumis' %}selected{% endif %}>ğŸ“® Soumis</option>
                <option value="en_etude" {% if financement.statut == 'en_etude' %}selected{% endif %}>ğŸ“š En Ã©tude</option>
                <option value="accepte" {% if financement.statut == 'accepte' %}selected{% endif %}>âœ… AcceptÃ©</option>
                <option value="refuse" {% if financement.statut == 'refuse' %}selected{% endif %}>âŒ RefusÃ©</option>
                <option value="clos" {% if financement.statut == 'clos' %}selected{% endif %}>ğŸ Clos</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary" {% if not all_documents_validated %}disabled title="Veuillez d'abord valider tous les documents"{% endif %}>
              ğŸ’¾ Mettre Ã  jour le statut
            </button>
            {% if not all_documents_validated %}
              <small class="text-danger d-block mt-2">
                <i class="fas fa-info-circle"></i> Veuillez d'abord valider tous les documents avant de changer le statut.
              </small>
            {% endif %}
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Section Documents de Financement -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">ğŸ“„ Documents de Financement</h5>
        </div>
        <div class="card-body">
          {% if documents %}
            <!-- RÃ©sumÃ© des documents -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="alert alert-info mb-0">
                  <strong>Total :</strong><br>
                  <span class="display-6">{{ documents_counts.total }}</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="alert alert-success mb-0">
                  <strong>ValidÃ©s :</strong><br>
                  <span class="display-6" style="color: #28a745;">{{ documents_counts.valide }}</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="alert alert-warning mb-0">
                  <strong>En attente :</strong><br>
                  <span class="display-6" style="color: #ffc107;">{{ documents_counts.en_attente }}</span>
                </div>
              </div>
              <div class="col-md-3">
                <div class="alert alert-danger mb-0">
                  <strong>RejetÃ©s :</strong><br>
                  <span class="display-6" style="color: #dc3545;">{{ documents_counts.rejete }}</span>
                </div>
              </div>
            </div>

            <!-- Tableau des documents -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>ğŸ“„ Document</th>
                    <th>ğŸ“Š Statut</th>
                    <th> Date</th>
                    <th>âš™ï¸ Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for doc in documents %}
                    <tr>
                      <td>
                        <strong>{{ doc.get_document_label }}</strong>
                      </td>
                      <td>
                        {% if doc.statut == 'valide' %}
                          <span class="badge bg-success p-2">âœ… ValidÃ©</span>
                        {% elif doc.statut == 'rejete' %}
                          <span class="badge bg-danger p-2">âŒ RejetÃ©</span><br>
                          {% if doc.raison_rejet %}
                            <small class="text-danger d-block mt-1"><strong>{{ doc.raison_rejet }}</strong></small>
                          {% endif %}
                        {% elif doc.statut == 'en_attente' %}
                          <span class="badge bg-warning text-dark p-2">â³ En attente</span>
                        {% endif %}
                      </td>
                      <td>
                        <small class="text-muted">{{ doc.created_at|date:"d/m/Y H:i" }}</small>
                      </td>
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <!-- Bouton Voir -->
                          <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-outline-primary" title="Voir le document">
                            <i class="fas fa-eye"></i> Voir
                          </a>
                          
                          <!-- Bouton Valider (visible si en attente ou rejetÃ©) -->
                          {% if doc.statut != 'valide' %}
                            <a href="{% url 'commercial_financing_document_validate' doc.id %}" class="btn btn-outline-success" title="Valider ce document">
                              <i class="fas fa-check"></i> Valider
                            </a>
                          {% endif %}
                          
                          <!-- Bouton Rejeter (visible si en attente ou validÃ©) -->
                          {% if doc.statut != 'rejete' %}
                            <a href="{% url 'commercial_financing_document_reject' doc.id %}" class="btn btn-outline-danger" title="Rejeter ce document">
                              <i class="fas fa-times"></i> Rejeter
                            </a>
                          {% endif %}
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <!-- Message si tous les documents sont validÃ©s -->
            {% if all_documents_validated %}
              <div class="alert alert-success mt-4">
                <i class="fas fa-check-circle"></i> <strong>âœ… Tous les documents ont Ã©tÃ© validÃ©s!</strong><br>
                Vous pouvez maintenant mettre Ã  jour le statut de la demande de financement.
              </div>
            {% elif documents_counts.rejete > 0 %}
              <div class="alert alert-danger mt-4">
                <i class="fas fa-exclamation-circle"></i> <strong>âš ï¸ Attention - Documents rejetÃ©s</strong><br>
                {{ documents_counts.rejete }} document(s) rejetÃ©(s). Le client doit corriger et renvoyer ces documents avant de continuer.
              </div>
            {% elif documents_counts.en_attente > 0 %}
              <div class="alert alert-warning mt-4">
                <i class="fas fa-hourglass-end"></i> <strong>â³ En attente de vÃ©rification</strong><br>
                {{ documents_counts.en_attente }} document(s) attendent votre validation. Veuillez examiner et valider ou rejeter ces documents.
              </div>
            {% endif %}

          {% else %}
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> <strong>Aucun document uploadÃ©</strong><br>
              Le client n'a pas encore tÃ©lÃ©chargÃ© de documents pour cette demande de financement.
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% if financement.statut == 'soumis' %}
    <div class="alert alert-info">
      <strong>ğŸ“® Demande soumise</strong><br>
      Cette demande vient d'Ãªtre soumise par le client. Passez-la en "En Ã©tude" pour indiquer que vous l'examinez.
    </div>
  {% elif financement.statut == 'en_etude' %}
    <div class="alert alert-warning">
      <strong>ğŸ“š Demande en cours d'Ã©tude</strong><br>
      Cette demande est actuellement examinÃ©e. Passez-la Ã  "AcceptÃ©" ou "RefusÃ©" selon la dÃ©cision de la banque.
    </div>
  {% elif financement.statut == 'accepte' %}
    <div class="alert alert-success">
      <strong>âœ… Demande acceptÃ©e</strong><br>
      Le financement a Ã©tÃ© acceptÃ© par la banque. Le client a Ã©tÃ© notifiÃ©. Passez le dossier Ã  "Clos" une fois le financement complÃ©tÃ©.
    </div>
  {% elif financement.statut == 'refuse' %}
    <div class="alert alert-danger">
      <strong>âŒ Demande refusÃ©e</strong><br>
      La demande de financement a Ã©tÃ© refusÃ©e par la banque. Le client a Ã©tÃ© notifiÃ©. Vous pouvez clore le dossier.
    </div>
  {% elif financement.statut == 'clos' %}
    <div class="alert alert-secondary">
      <strong>ğŸ Dossier clÃ´turÃ©</strong><br>
      Ce dossier de financement est terminÃ© et archivÃ©.
    </div>
  {% endif %}

  <div class="mt-4">
    <a href="{% url 'commercial_financing_list' %}" class="btn btn-secondary">â† Retour Ã  la liste</a>
  </div>
</div>
{% endblock %}
