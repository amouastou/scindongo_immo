{% extends 'base.html' %}
{% load static %}

{% block title %}D√©tail de Ma R√©servation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìã D√©tail de ma R√©servation</h2>
        <a href="{% url 'client_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>

    <!-- Informations principales -->
    <div class="row mb-4">
        <!-- R√©servation -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìå Informations R√©servation</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">ID R√©servation:</td>
                            <td><code>{{ reservation.id }}</code></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Unit√©:</td>
                            <td>{{ reservation.unite.reference }}<br>
                                <small class="text-muted">{{ reservation.unite.programme.nom }}</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Prix:</td>
                            <td><strong>{{ reservation.unite.prix_ttc|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Acompte:</td>
                            <td>{{ reservation.acompte|floatformat:0 }} FCFA</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Statut:</td>
                            <td>
                                <span class="badge bg-{% if reservation.statut == 'confirmee' %}success{% elif reservation.statut == 'en_cours' %}info{% elif reservation.statut == 'annulee' %}danger{% else %}warning{% endif %} fs-6">
                                    {{ reservation.get_statut_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">R√©serv√©e le:</td>
                            <td>{{ reservation.date_reservation|date:"d/m/Y" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Annulation (si annul√©e) -->
    {% if reservation.statut == 'annulee' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">‚ùå Informations d'Annulation</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger">
                        <strong>‚ö†Ô∏è R√©servation Annul√©e</strong><br>
                        Cette r√©servation a √©t√© annul√©e et ne peut plus √™tre modifi√©e. Vous pouvez cependant consulter les d√©tails ci-dessous.
                    </div>
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">Annul√©e le:</td>
                            <td>{{ reservation.annulee_le|date:"d/m/Y √† H:i" }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Motif:</td>
                            <td>{{ reservation.motif_annulation }}</td>
                        </tr>
                        {% if reservation.annulee_par %}
                        <tr>
                            <td class="fw-bold">Annul√©e par:</td>
                            <td>√âquipe commerciale SCINDONGO</td>
                        </tr>
                        {% endif %}
                    </table>
                    <div class="mt-3">
                        <a href="{% url 'programme_list' %}" class="btn btn-success">
                            <i class="fas fa-plus"></i> R√©server une autre unit√©
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Reste du contenu normal -->
    <div class="row mb-4">
        <!-- Unit√© -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üè† D√©tails de l'Unit√©</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">R√©f√©rence:</td>
                            <td>{{ reservation.unite.reference }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Programme:</td>
                            <td><a href="{% url 'programme_detail' reservation.unite.programme.id %}">{{ reservation.unite.programme.nom }}</a></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Mod√®le:</td>
                            <td>{{ reservation.unite.modele.nom }}<br>
                                <small class="text-muted">{{ reservation.unite.modele.surface_hab_m2 }} m¬≤</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Type:</td>
                            <td>{{ reservation.unite.modele.type.libelle }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Statut:</td>
                            <td>
                                <span class="badge bg-{% if reservation.unite.statut_disponibilite == 'disponible' %}success{% elif reservation.unite.statut_disponibilite == 'reserve' %}warning{% elif reservation.unite.statut_disponibilite == 'vendu' %}danger{% else %}secondary{% endif %}">
                                    {{ reservation.unite.get_statut_disponibilite_display }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents üìÑ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üìÑ Mes Documents</h5>
                </div>
                <div class="card-body">
                    
                    <!-- Status global des documents -->
                    <div class="alert {% if documents_valides %}alert-success{% elif documents_rejetes %}alert-danger{% else %}alert-info{% endif %} mb-4">
                        {% if documents_valides %}
                            ‚úÖ <strong>Tous vos documents sont valid√©s!</strong> Vous pouvez proc√©der aux prochaines √©tapes.
                        {% elif documents_rejetes %}
                            ‚ùå <strong>Certains documents ont √©t√© rejet√©s.</strong> Veuillez les corriger et re-uploader.
                        {% else %}
                            ‚è≥ <strong>Documents en attente de validation.</strong> Nos √©quipes les examineront prochainement.
                        {% endif %}
                    </div>

                    <!-- Tableau documents -->
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Type de document</th>
                                    <th>Statut</th>
                                    <th>Date upload</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                    <tr>
                                        <td class="fw-bold">
                                            {% if doc.document_type == 'cni' %}
                                                ü™™ {{ doc.get_document_type_display }}
                                            {% elif doc.document_type == 'photo' %}
                                                üì∏ {{ doc.get_document_type_display }}
                                            {% else %}
                                                üè† {{ doc.get_document_type_display }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if doc.statut == 'valide' %}
                                                <span class="badge bg-success">‚úÖ Valid√©</span>
                                            {% elif doc.statut == 'rejete' %}
                                                <span class="badge bg-danger">‚ùå Rejet√©</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">‚è≥ En attente</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ doc.created_at|date:"d/m/Y √† H:i" }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-outline-primary" title="Voir document">
                                                    <i class="fas fa-eye"></i> Voir
                                                </a>
                                                {% if doc.statut == 'rejete' or doc.statut == 'en_attente' %}
                                                    <a href="{% url 'reservation_document_modify' doc.id %}" class="btn btn-outline-warning" title="Modifier document">
                                                        <i class="fas fa-edit"></i> Modifier
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    
                                    <!-- Raison rejet si applicable -->
                                    {% if doc.statut == 'rejete' and doc.raison_rejet %}
                                        <tr class="table-danger">
                                            <td colspan="4">
                                                <div class="alert alert-danger mb-0">
                                                    <strong>‚ö†Ô∏è Raison du rejet:</strong><br>
                                                    {{ doc.raison_rejet }}
                                                    {% if doc.verifie_par %}
                                                        <br>
                                                        <small class="text-muted">
                                                            Rejet√© par {{ doc.verifie_par.get_short_name }} le {{ doc.verifie_le|date:"d/m/Y √† H:i" }}
                                                        </small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% empty %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fs-4 mb-2 d-block"></i>
                                            Aucun document upload√©
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Info documents manquants -->
                    {% if missing_documents %}
                        <div class="alert alert-warning">
                            <strong>üìù Documents √† uploader:</strong>
                            <ul class="mb-0 mt-2">
                                {% for missing in missing_documents %}
                                    <li>{{ missing.label }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <!-- Bouton pour aller uploader documents (d√©sactiv√© si annul√©e) -->
                    {% if not documents_valides %}
                        {% if reservation.statut == 'annulee' %}
                            <button class="btn btn-secondary" disabled title="R√©servation annul√©e">
                                <i class="fas fa-ban"></i> Upload d√©sactiv√© (R√©servation annul√©e)
                            </button>
                        {% else %}
                            <a href="{% url 'reservation_documents_upload' reservation.id %}" class="btn btn-warning">
                                <i class="fas fa-upload"></i> Uploader / Modifier mes documents
                            </a>
                        {% endif %}
                    {% endif %}

                </div>
            </div>
        </div>
    </div>

    <!-- Prochaines √©tapes (masqu√©es si annul√©e) -->
    {% if reservation.statut != 'annulee' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚öôÔ∏è Prochaines √âtapes</h5>
                </div>
                <div class="card-body">
                    <!-- BLOCAGE si docs pas valid√©s -->
                    {% if not documents_valides %}
                        <div class="alert alert-danger mb-4">
                            <h5 class="alert-heading">üîí √âtapes Bloqu√©es</h5>
                            <p class="mb-0">
                                Vous devez d'abord valider tous vos documents avant de pouvoir proc√©der aux √©tapes suivantes.
                                <br><strong>Documents manquants ou en attente:</strong>
                                <ul class="mb-0 mt-2">
                                    {% for missing in missing_documents %}
                                        <li>{{ missing.label }}</li>
                                    {% endfor %}
                                    {% if documents_rejetes %}
                                        <li>Documents rejet√©s √† corriger</li>
                                    {% endif %}
                                </ul>
                            </p>
                        </div>
                        
                        <div class="text-center">
                            <a href="{% url 'reservation_documents_upload' reservation.id %}" class="btn btn-lg btn-warning">
                                <i class="fas fa-upload"></i> Compl√©ter vos documents
                            </a>
                        </div>
                    {% else %}
                        <!-- CONTENU accessible si docs valid√©s -->
                        <div class="row">
                            <!-- Financement -->
                            <div class="col-md-3 mb-3">
                                {% if has_financement %}
                                        <a href="{% url 'client_financing_detail' reservation.financement.id %}" class="text-decoration-none">
                                            <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                                    <div class="fw-bold">Financement</div>
                                                    <small class="text-muted">{{ reservation.financement.get_statut_display }}</small>
                                                    <div class="mt-2">
                                                        <span class="badge bg-info">{{ reservation.financement.montant|floatformat:0 }} FCFA</span>
                                                    </div>
                                                    <div class="mt-3">
                                                        <a href="{% url 'financing_documents_upload' reservation.financement.id %}" class="btn btn-sm btn-primary">
                                                            <i class="fas fa-cloud-upload"></i> G√©rer mes documents
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                {% else %}
                                    <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="text-decoration-none">
                                        <div class="card border-warning h-100 hover-shadow" style="cursor: pointer;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-coins text-warning fs-3 mb-2"></i>
                                                <div class="fw-bold">Financement</div>
                                                <small class="text-muted">Non ajout√©</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-warning">Cliquez pour ajouter</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            </div>

                            <!-- Contrat -->
                            <div class="col-md-3 mb-3">
                                {% if has_contrat %}
                                    <a href="#contratDetails" class="text-decoration-none" data-bs-toggle="collapse">
                                        <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                                <div class="fw-bold">Contrat</div>
                                                <small class="text-muted">
                                                    {% if reservation.contrat.statut == 'signe' %}
                                                        ‚úì Sign√©
                                                    {% else %}
                                                        {{ reservation.contrat.get_statut_display }}
                                                    {% endif %}
                                                </small>
                                                <div class="mt-2">
                                                    <span class="badge bg-success">Voir d√©tails</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                {% else %}
                                    <div class="card border-warning h-100">
                                        <div class="card-body text-center">
                                            <i class="fas fa-file-contract text-warning fs-3 mb-2"></i>
                                            <div class="fw-bold">Contrat</div>
                                            <small class="text-muted">Non cr√©√©</small>
                                            <div class="mt-2">
                                                <span class="badge bg-secondary">En attente</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Paiement -->
                            <div class="col-md-3 mb-3">
                                {% if paiements %}
                                    <a href="#paiementsDetails" class="text-decoration-none" data-bs-toggle="collapse">
                                        <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                                <div class="fw-bold">Paiements</div>
                                                <small class="text-muted">{{ paiements.count }} paiement(s)</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-info">{{ total_payes|floatformat:0 }} FCFA</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                {% else %}
                                    <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="text-decoration-none">
                                        <div class="card border-warning h-100 hover-shadow" style="cursor: pointer;">
                                            <div class="card-body text-center">
                                                <i class="fas fa-money-bill-wave text-warning fs-3 mb-2"></i>
                                                <div class="fw-bold">Paiement</div>
                                                <small class="text-muted">Non enregistr√©</small>
                                                <div class="mt-2">
                                                    <span class="badge bg-warning">Cliquez pour payer</span>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                {% endif %}
                            </div>

                            <!-- Statut G√©n√©ral -->
                            <div class="col-md-3 mb-3">
                                {% if reservation.statut == 'confirmee' %}
                                    <div class="card border-success bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-double text-success fs-3 mb-2"></i>
                                            <div class="fw-bold">Confirm√©e</div>
                                            <small class="text-muted">‚úì Compl√®te</small>
                                        </div>
                                    </div>
                                {% elif reservation.statut == 'en_cours' %}
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <i class="fas fa-hourglass-half text-info fs-3 mb-2"></i>
                                            <div class="fw-bold">En cours</div>
                                            <small class="text-muted">√Ä compl√©ter</small>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <i class="fas fa-times-circle text-danger fs-3 mb-2"></i>
                                            <div class="fw-bold">{{ reservation.get_statut_display }}</div>
                                            <small class="text-muted">-</small>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}  <!-- Fin section "Prochaines √©tapes" si annul√©e -->

    <!-- Suivi Chantier (visible seulement si contrat sign√©) -->
    {% if contrat_signe %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üèóÔ∏è Suivi de Chantier</h5>
                </div>
                <div class="card-body">
                    {% if avancements_chantier %}
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Progression de la construction de votre bien</strong>
                            <br>Suivez ici l'√©volution des travaux de construction de votre unit√©.
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>√âtape</th>
                                        <th>Progression</th>
                                        <th>Date</th>
                                        <th>Photos</th>
                                        <th>Commentaire</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for avancement in avancements_chantier %}
                                    <tr>
                                        <td><strong>{{ avancement.etape }}</strong></td>
                                        <td>
                                            <div style="width: 120px;">
                                                <div class="progress" style="height: 25px;">
                                                    <div class="progress-bar {% if avancement.pourcentage == 100 %}bg-success{% elif avancement.pourcentage >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                                         data-percentage="{{ avancement.pourcentage }}" 
                                                         style="width: 0%;">
                                                        {{ avancement.pourcentage }}%
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ avancement.date_pointage|date:"d/m/Y" }}</td>
                                        <td>
                                            {% if avancement.photos.exists %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-images"></i> {{ avancement.photos.count }} photo(s)
                                                </span>
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if avancement.commentaire %}
                                                <small class="text-muted">{{ avancement.commentaire|truncatewords:10 }}</small>
                                            {% else %}
                                                <span class="text-muted">‚Äî</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center mt-3">
                            <a href="{% url 'client_suivi_chantier' %}" class="btn btn-warning">
                                <i class="fas fa-construction"></i> Voir tous les avancements
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-secondary mb-0">
                            <i class="fas fa-hard-hat"></i> 
                            Aucun avancement de chantier enregistr√© pour le moment. 
                            Les mises √† jour appara√Ætront ici d√®s que la construction d√©marre.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- D√©tails Financement -->
    {% if has_financement %}
        <div class="collapse" id="financementDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üí∞ D√©tails du Financement</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Banque:</strong><br>
                                    {{ reservation.financement.banque.nom }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Type:</strong><br>
                                    {{ reservation.financement.type }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Montant:</strong><br>
                                    {{ reservation.financement.montant|floatformat:0 }} FCFA
                                </div>
                                <div class="col-md-3">
                                    <strong>Statut:</strong><br>
                                    <span class="badge bg-{% if reservation.financement.statut == 'accepte' %}success{% elif reservation.financement.statut == 'refuse' %}danger{% elif reservation.financement.statut == 'en_etude' %}info{% else %}warning{% endif %}">
                                        {{ reservation.financement.get_statut_display }}
                                    </span>
                                </div>
                            </div>
                            <hr>
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                <strong>Suivi du dossier :</strong><br>
                                {% if reservation.financement.statut == 'soumis' %}
                                    Votre demande a √©t√© soumise √† la banque. Elle sera √©tudi√©e dans les 5-10 jours.
                                {% elif reservation.financement.statut == 'en_etude' %}
                                    Votre dossier est en cours d'√©tude par la banque. Vous serez notifi√© de la d√©cision.
                                {% elif reservation.financement.statut == 'accepte' %}
                                    üéâ F√©licitations ! Votre demande de financement a √©t√© accept√©e par la banque.
                                {% elif reservation.financement.statut == 'refuse' %}
                                    ‚ùå Votre demande de financement a √©t√© refus√©e. Contactez-nous pour plus d'informations.
                                {% elif reservation.financement.statut == 'clos' %}
                                    Dossier de financement cl√¥tur√©.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- OTP Signature Section -->
    {% if has_contrat and contrat_otp %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üîê Code OTP - Signature S√©curis√©e</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-info-circle"></i> 
                            Utilisez ce code OTP pour signer votre contrat de mani√®re s√©curis√©e.
                        </div>
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light border rounded">
                                    <small class="text-muted d-block">Votre code OTP</small>
                                    <div class="h3 font-monospace font-weight-bold" style="letter-spacing: 8px; font-size: 2rem; font-family: 'Courier New', monospace;">
                                        {{ contrat_otp }}
                                    </div>
                                    <small class="text-danger d-block mt-2">
                                        <i class="fas fa-clock"></i> 
                                        Valide pendant <span id="otp-timer">5:00</span>
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="alert alert-warning" role="alert">
                                    <strong><i class="fas fa-exclamation-triangle"></i> Importante:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>Gardez ce code secret et ne le partagez avec personne</li>
                                        <li>Vous disposez de <strong>3 tentatives</strong> pour entrer le code correctement</li>
                                        <li>Une fois le code utilis√©, il sera invalid√©</li>
                                        <li>Valide pendant 5 minutes √† partir de sa g√©n√©ration</li>
                                    </ul>
                                </div>
                                <a href="{% url 'client_sign_contrat' reservation.id reservation.contrat.id %}" class="btn btn-success">
                                    <i class="fas fa-pen-fancy"></i> Signer le contrat avec OTP
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OTP Timer Data -->
        <div id="otp-data" data-remaining="{% if otp_remaining %}{{ otp_remaining }}{% else %}300{% endif %}" style="display:none;"></div>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // OTP Timer
                const otpData = document.getElementById('otp-data');
                const otpRemaining = parseInt(otpData.dataset.remaining) || 300;
                let timeLeft = otpRemaining;
                const timerElement = document.getElementById('otp-timer');
                
                function updateTimer() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                    
                    if (timeLeft > 0) {
                        timeLeft--;
                        setTimeout(updateTimer, 1000);
                    } else {
                        timerElement.parentElement.innerHTML = '<strong class="text-danger">Code expir√© - Demandez un nouveau code OTP</strong>';
                    }
                }
                updateTimer();
            });
        </script>
    {% endif %}

    <!-- D√©tails Contrat -->
    {% if has_contrat %}
        <div class="collapse" id="contratDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">üìÑ D√©tails du Contrat</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>Num√©ro:</strong><br>
                                    <code>{{ reservation.contrat.numero }}</code>
                                </div>
                                <div class="col-md-3">
                                    <strong>Statut:</strong><br>
                                    <span class="badge bg-{% if reservation.contrat.statut == 'signe' %}success{% elif reservation.contrat.statut == 'annule' %}danger{% else %}warning{% endif %}">
                                        {{ reservation.contrat.get_statut_display }}
                                    </span>
                                </div>
                                <div class="col-md-3">
                                    {% if reservation.contrat.signe_le %}
                                        <strong>Sign√© le:</strong><br>
                                        {{ reservation.contrat.signe_le|date:"d/m/Y" }}
                                    {% else %}
                                        <strong>En attente de signature</strong>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    {% if reservation.contrat.pdf %}
                                        <a href="{{ reservation.contrat.pdf.url }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i> T√©l√©charger le Contrat
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Paiements -->
    {% if paiements %}
        <div class="collapse" id="paiementsDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üí≥ Historique des Paiements</h5>
                            <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="btn btn-sm btn-light">
                                <i class="fas fa-plus"></i> Ajouter un paiement
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Montant</th>
                                            <th>Moyen</th>
                                            <th>Source</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for paiement in paiements %}
                                            <tr>
                                                <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                                <td><strong>{{ paiement.montant|floatformat:0 }} FCFA</strong></td>
                                                <td>{{ paiement.get_moyen_display }}</td>
                                                <td>{{ paiement.source }}</td>
                                                <td>
                                                    <span class="badge bg-{% if paiement.statut == 'valide' %}success{% elif paiement.statut == 'rejete' %}danger{% else %}warning{% endif %}">
                                                        {{ paiement.get_statut_display }}
                                                    </span>
                                                </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- R√©sum√© des paiements -->
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-3">
                                <strong>Total Pay√©:</strong><br>
                                <span class="badge bg-success fs-5">{{ total_payes|floatformat:0 }} FCFA</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Montant Total:</strong><br>
                                <span class="badge bg-info fs-5">{{ reservation.unite.prix_ttc|floatformat:0 }} FCFA</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Restant √† Payer:</strong><br>
                                <span class="badge bg-{% if montant_restant <= 0 %}success{% else %}warning{% endif %} fs-5">
                                    {{ montant_restant|floatformat:0 }} FCFA
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                {% if montant_restant > 0 %}
                                    <a href="{% url 'pay_reservation' reservation.id %}" class="btn btn-success">
                                        <i class="fas fa-money-bill-wave"></i> Payer
                                    </a>
                                {% else %}
                                    <span class="badge bg-success fs-6">‚úì Pay√© int√©gralement</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aucun paiement enregistr√© pour cette r√©servation.
                    {% if reservation.statut == 'en_cours' %}
                        <a href="{% url 'pay_reservation' reservation.id %}" class="alert-link">Effectuer un paiement</a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <a href="{% url 'client_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour au Tableau de Bord
            </a>
            {% if reservation.statut == 'en_cours' and montant_restant > 0 %}
                <a href="{% url 'pay_reservation' reservation.id %}" class="btn btn-success">
                    <i class="fas fa-money-bill-wave"></i> Effectuer un Paiement
                </a>
            {% endif %}
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
</style>

<script>
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', function() {
    // Appliquer la largeur des progress bars bas√©e sur data-percentage
    document.querySelectorAll('.progress-bar[data-percentage]').forEach(function(bar) {
      const percentage = bar.getAttribute('data-percentage');
      bar.style.width = percentage + '%';
    });
  });
  /*]]>*/
</script>
{% endblock %}
