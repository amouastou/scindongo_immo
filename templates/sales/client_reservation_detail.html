{% extends 'base.html' %}
{% load static %}

{% block title %}D√©tail de Ma R√©servation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìã D√©tail de ma R√©servation</h2>
        <a href="{% url 'client_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
    </div>

    <!-- Informations principales -->
    <div class="row mb-4">
        <!-- R√©servation -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìå Informations R√©servation</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">ID R√©servation:</td>
                            <td><code>{{ reservation.id }}</code></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Unit√©:</td>
                            <td>{{ reservation.unite.reference }}<br>
                                <small class="text-muted">{{ reservation.unite.programme.nom }}</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Prix:</td>
                            <td><strong>{{ reservation.unite.prix_ttc|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Acompte:</td>
                            <td>{{ reservation.acompte|floatformat:0 }} FCFA</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Statut:</td>
                            <td>
                                <span class="badge bg-{% if reservation.statut == 'confirmee' %}success{% elif reservation.statut == 'en_cours' %}info{% elif reservation.statut == 'annulee' %}danger{% else %}warning{% endif %} fs-6">
                                    {{ reservation.get_statut_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">R√©serv√©e le:</td>
                            <td>{{ reservation.date_reservation|date:"d/m/Y" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Unit√© -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üè† D√©tails de l'Unit√©</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">R√©f√©rence:</td>
                            <td>{{ reservation.unite.reference }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Programme:</td>
                            <td><a href="{% url 'programme_detail' reservation.unite.programme.id %}">{{ reservation.unite.programme.nom }}</a></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Mod√®le:</td>
                            <td>{{ reservation.unite.modele.nom }}<br>
                                <small class="text-muted">{{ reservation.unite.modele.surface_hab_m2 }} m¬≤</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Type:</td>
                            <td>{{ reservation.unite.modele.type.libelle }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Statut:</td>
                            <td>
                                <span class="badge bg-{% if reservation.unite.statut_disponibilite == 'disponible' %}success{% elif reservation.unite.statut_disponibilite == 'reserve' %}warning{% elif reservation.unite.statut_disponibilite == 'vendu' %}danger{% else %}secondary{% endif %}">
                                    {{ reservation.unite.get_statut_disponibilite_display }}
                                </span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Prochaines √©tapes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚öôÔ∏è Prochaines √âtapes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Financement -->
                        <div class="col-md-3 mb-3">
                            {% if has_financement %}
                                <a href="#financementDetails" class="text-decoration-none" data-bs-toggle="collapse">
                                    <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                            <div class="fw-bold">Financement</div>
                                            <small class="text-muted">{{ reservation.financement.get_statut_display }}</small>
                                            <div class="mt-2">
                                                <span class="badge bg-info">{{ reservation.financement.montant|floatformat:0 }} FCFA</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% else %}
                                <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="text-decoration-none">
                                    <div class="card border-warning h-100 hover-shadow" style="cursor: pointer;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-coins text-warning fs-3 mb-2"></i>
                                            <div class="fw-bold">Financement</div>
                                            <small class="text-muted">Non ajout√©</small>
                                            <div class="mt-2">
                                                <span class="badge bg-warning">Cliquez pour ajouter</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% endif %}
                        </div>

                        <!-- Contrat -->
                        <div class="col-md-3 mb-3">
                            {% if has_contrat %}
                                <a href="#contratDetails" class="text-decoration-none" data-bs-toggle="collapse">
                                    <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                            <div class="fw-bold">Contrat</div>
                                            <small class="text-muted">
                                                {% if reservation.contrat.statut == 'signe' %}
                                                    ‚úì Sign√©
                                                {% else %}
                                                    {{ reservation.contrat.get_statut_display }}
                                                {% endif %}
                                            </small>
                                            <div class="mt-2">
                                                <span class="badge bg-success">Voir d√©tails</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% else %}
                                <div class="card border-warning h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-contract text-warning fs-3 mb-2"></i>
                                        <div class="fw-bold">Contrat</div>
                                        <small class="text-muted">Non cr√©√©</small>
                                        <div class="mt-2">
                                            <span class="badge bg-secondary">En attente</span>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Paiement -->
                        <div class="col-md-3 mb-3">
                            {% if paiements %}
                                <a href="#paiementsDetails" class="text-decoration-none" data-bs-toggle="collapse">
                                    <div class="card border-success bg-light h-100 hover-shadow" style="cursor: pointer;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-check-circle text-success fs-3 mb-2"></i>
                                            <div class="fw-bold">Paiement</div>
                                            <small class="text-muted">
                                                {{ paiements|length }} paiement(s)
                                            </small>
                                            <div class="mt-2">
                                                <span class="badge bg-info">{{ total_payes|floatformat:0 }} FCFA</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% else %}
                                <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="text-decoration-none">
                                    <div class="card border-warning h-100 hover-shadow" style="cursor: pointer;">
                                        <div class="card-body text-center">
                                            <i class="fas fa-money-bill-wave text-warning fs-3 mb-2"></i>
                                            <div class="fw-bold">Paiement</div>
                                            <small class="text-muted">Non enregistr√©</small>
                                            <div class="mt-2">
                                                <span class="badge bg-warning">Cliquez pour payer</span>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            {% endif %}
                        </div>

                        <!-- Statut G√©n√©ral -->
                        <div class="col-md-3 mb-3">
                            {% if reservation.statut == 'confirmee' %}
                                <div class="card border-success bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-check-double text-success fs-3 mb-2"></i>
                                        <div class="fw-bold">Confirm√©e</div>
                                        <small class="text-muted">‚úì Compl√®te</small>
                                    </div>
                                </div>
                            {% elif reservation.statut == 'en_cours' %}
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <i class="fas fa-hourglass-half text-info fs-3 mb-2"></i>
                                        <div class="fw-bold">En cours</div>
                                        <small class="text-muted">√Ä compl√©ter</small>
                                    </div>
                                </div>
                            {% else %}
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <i class="fas fa-times-circle text-danger fs-3 mb-2"></i>
                                        <div class="fw-bold">{{ reservation.get_statut_display }}</div>
                                        <small class="text-muted">-</small>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- D√©tails Financement -->
    {% if has_financement %}
        <div class="collapse" id="financementDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üí∞ D√©tails du Financement</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Banque:</strong><br>
                                    {{ reservation.financement.banque.nom }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Type:</strong><br>
                                    {{ reservation.financement.type }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Montant:</strong><br>
                                    {{ reservation.financement.montant|floatformat:0 }} FCFA
                                </div>
                                <div class="col-md-3">
                                    <strong>Statut:</strong><br>
                                    <span class="badge bg-{% if reservation.financement.statut == 'accepte' %}success{% elif reservation.financement.statut == 'refuse' %}danger{% elif reservation.financement.statut == 'en_etude' %}info{% else %}warning{% endif %}">
                                        {{ reservation.financement.get_statut_display }}
                                    </span>
                                </div>
                            </div>
                            <hr>
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                <strong>Suivi du dossier :</strong><br>
                                {% if reservation.financement.statut == 'soumis' %}
                                    Votre demande a √©t√© soumise √† la banque. Elle sera √©tudi√©e dans les 5-10 jours.
                                {% elif reservation.financement.statut == 'en_etude' %}
                                    Votre dossier est en cours d'√©tude par la banque. Vous serez notifi√© de la d√©cision.
                                {% elif reservation.financement.statut == 'accepte' %}
                                    üéâ F√©licitations ! Votre demande de financement a √©t√© accept√©e par la banque.
                                {% elif reservation.financement.statut == 'refuse' %}
                                    ‚ùå Votre demande de financement a √©t√© refus√©e. Contactez-nous pour plus d'informations.
                                {% elif reservation.financement.statut == 'clos' %}
                                    Dossier de financement cl√¥tur√©.
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- D√©tails Contrat -->
    {% if has_contrat %}
        <div class="collapse" id="contratDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">üìÑ D√©tails du Contrat</h5>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>Num√©ro:</strong><br>
                                    <code>{{ reservation.contrat.numero }}</code>
                                </div>
                                <div class="col-md-3">
                                    <strong>Statut:</strong><br>
                                    <span class="badge bg-{% if reservation.contrat.statut == 'signe' %}success{% elif reservation.contrat.statut == 'annule' %}danger{% else %}warning{% endif %}">
                                        {{ reservation.contrat.get_statut_display }}
                                    </span>
                                </div>
                                <div class="col-md-3">
                                    {% if reservation.contrat.signe_le %}
                                        <strong>Sign√© le:</strong><br>
                                        {{ reservation.contrat.signe_le|date:"d/m/Y" }}
                                    {% else %}
                                        <strong>En attente de signature</strong>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    {% if reservation.contrat.pdf %}
                                        <a href="{{ reservation.contrat.pdf.url }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download"></i> T√©l√©charger le Contrat
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Paiements -->
    {% if paiements %}
        <div class="collapse" id="paiementsDetails">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üí≥ Historique des Paiements</h5>
                            <a href="{% url 'client_payment_mode_choice' reservation.id %}" class="btn btn-sm btn-light">
                                <i class="fas fa-plus"></i> Ajouter un paiement
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Montant</th>
                                            <th>Moyen</th>
                                            <th>Source</th>
                                            <th>Statut</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for paiement in paiements %}
                                            <tr>
                                                <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                                <td><strong>{{ paiement.montant|floatformat:0 }} FCFA</strong></td>
                                                <td>{{ paiement.get_moyen_display }}</td>
                                                <td>{{ paiement.source }}</td>
                                                <td>
                                                    <span class="badge bg-{% if paiement.statut == 'valide' %}success{% elif paiement.statut == 'rejete' %}danger{% else %}warning{% endif %}">
                                                        {{ paiement.get_statut_display }}
                                                    </span>
                                                </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- R√©sum√© des paiements -->
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-3">
                                <strong>Total Pay√©:</strong><br>
                                <span class="badge bg-success fs-5">{{ total_payes|floatformat:0 }} FCFA</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Montant Total:</strong><br>
                                <span class="badge bg-info fs-5">{{ reservation.unite.prix_ttc|floatformat:0 }} FCFA</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Restant √† Payer:</strong><br>
                                <span class="badge bg-{% if montant_restant <= 0 %}success{% else %}warning{% endif %} fs-5">
                                    {{ montant_restant|floatformat:0 }} FCFA
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                {% if montant_restant > 0 %}
                                    <a href="{% url 'pay_reservation' reservation.id %}" class="btn btn-success">
                                        <i class="fas fa-money-bill-wave"></i> Payer
                                    </a>
                                {% else %}
                                    <span class="badge bg-success fs-6">‚úì Pay√© int√©gralement</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aucun paiement enregistr√© pour cette r√©servation.
                    {% if reservation.statut == 'en_cours' %}
                        <a href="{% url 'pay_reservation' reservation.id %}" class="alert-link">Effectuer un paiement</a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <a href="{% url 'client_dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour au Tableau de Bord
            </a>
            {% if reservation.statut == 'en_cours' and montant_restant > 0 %}
                <a href="{% url 'pay_reservation' reservation.id %}" class="btn btn-success">
                    <i class="fas fa-money-bill-wave"></i> Effectuer un Paiement
                </a>
            {% endif %}
        </div>
    </div>
</div>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
</style>
{% endblock %}
