{% extends 'base.html' %}
{% load static %}

{% block title %}D√©tail R√©servation - Commercial{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üìã D√©tail de la R√©servation</h2>
        <a href="{% url 'commercial_reservation_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Retour √† la Liste
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Informations R√©servation -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üìå Informations R√©servation</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">ID R√©servation:</td>
                            <td><code>{{ reservation.id }}</code></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Client:</td>
                            <td>{{ reservation.client.prenom }} {{ reservation.client.nom }}<br>
                                <small class="text-muted">{{ reservation.client.email }}</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Unit√©:</td>
                            <td>{{ reservation.unite.reference }}<br>
                                <small class="text-muted">{{ reservation.unite.programme.nom }}</small>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Prix Unit√©:</td>
                            <td><strong>{{ reservation.unite.prix_ttc|floatformat:0 }} FCFA</strong></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Acompte:</td>
                            <td>{{ reservation.acompte|floatformat:0 }} FCFA</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Statut:</td>
                            <td>
                                <span class="badge bg-{% if reservation.statut == 'confirmee' %}success{% elif reservation.statut == 'en_cours' %}info{% elif reservation.statut == 'annulee' %}danger{% else %}warning{% endif %} fs-6">
                                    {{ reservation.get_statut_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Date R√©servation:</td>
                            <td>{{ reservation.date_reservation|date:"d/m/Y" }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Informations Client -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üë§ Informations Client</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td class="fw-bold">Nom Complet:</td>
                            <td>{{ reservation.client.prenom }} {{ reservation.client.nom }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Email:</td>
                            <td><a href="mailto:{{ reservation.client.email }}">{{ reservation.client.email }}</a></td>
                        </tr>
                        <tr>
                            <td class="fw-bold">T√©l√©phone:</td>
                            <td>{{ reservation.client.telephone }}</td>
                        </tr>
                        <tr>
                            <td class="fw-bold">KYC Statut:</td>
                            <td>
                                {% if reservation.client.kyc_statut %}
                                    <span class="badge bg-{% if reservation.client.kyc_statut == 'v√©rifi√©e' %}success{% else %}warning{% endif %}">
                                        {{ reservation.client.kyc_statut }}
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning">Non renseign√©</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="fw-bold">Nombre R√©servations:</td>
                            <td>{{ reservation.client.reservations.count }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- üìÑ DOCUMENTS SECTION -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üìÑ Documents du Client</h5>
                </div>
                <div class="card-body">
                    
                    <!-- Status Global -->
                    <div class="alert {% if documents_complete %}alert-success{% elif missing_documents %}alert-danger{% else %}alert-info{% endif %} mb-4">
                        {% if documents_complete %}
                            ‚úÖ <strong>Tous les documents sont valid√©s!</strong>
                        {% elif missing_documents %}
                            ‚ùå <strong>Documents manquants ou en attente:</strong>
                            <ul class="mb-0 mt-2">
                                {% for doc_type in missing_documents %}
                                    <li>{{ doc_type.label }}</li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            ‚è≥ <strong>Documents en cours de validation</strong>
                        {% endif %}
                    </div>

                    <!-- Tableau Documents -->
                    <div class="table-responsive mb-4">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Type</th>
                                    <th>Statut</th>
                                    <th>Upload√© le</th>
                                    <th>V√©rifi√© par</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in documents %}
                                    <tr>
                                        <td class="fw-bold">
                                            {% if doc.document_type == 'cni' %}ü™™{% elif doc.document_type == 'photo' %}üì∏{% else %}üè†{% endif %}
                                            {{ doc.get_document_type_display }}
                                        </td>
                                        <td>
                                            {% if doc.statut == 'valide' %}
                                                <span class="badge bg-success">‚úÖ Valid√©</span>
                                            {% elif doc.statut == 'rejete' %}
                                                <span class="badge bg-danger">‚ùå Rejet√©</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">‚è≥ En attente</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ doc.created_at|date:"d/m/Y √† H:i" }}</td>
                                        <td>
                                            {% if doc.verifie_par %}
                                                <small>{{ doc.verifie_par.get_short_name }}</small><br>
                                                <small class="text-muted">{{ doc.verifie_le|date:"d/m/Y" }}</small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <!-- T√©l√©charger -->
                                                <a href="{{ doc.fichier.url }}" target="_blank" class="btn btn-outline-primary btn-sm" title="T√©l√©charger">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                                
                                                <!-- Valider -->
                                                {% if doc.statut != 'valide' %}
                                                    <a href="{% url 'commercial_document_validate' doc.id %}" class="btn btn-outline-success btn-sm" title="Valider ce document" onclick="return confirm('Valider ce document?')">
                                                        <i class="fas fa-check"></i> Valider
                                                    </a>
                                                {% endif %}
                                                
                                                <!-- Rejeter -->
                                                {% if doc.statut != 'rejete' %}
                                                    <a href="{% url 'commercial_document_reject' doc.id %}" class="btn btn-outline-danger btn-sm" title="Rejeter ce document">
                                                        <i class="fas fa-times"></i> Rejeter
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fs-4 mb-2 d-block"></i>
                                            Aucun document upload√© par le client
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- üí¨ MESSAGE AU CLIENT SECTION -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üí¨ Envoyer un Message au Client</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Utilisez ce formulaire pour communiquer directement avec le client concernant sa r√©servation, ses documents ou toute autre information importante.
                    </p>
                    
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="send_message">
                        
                        <div class="mb-3">
                            <label for="messageText" class="form-label">Votre Message</label>
                            <textarea class="form-control" id="messageText" name="message" rows="5" 
                                      placeholder="Saisissez votre message au client..." 
                                      required></textarea>
                            <small class="text-muted d-block mt-2">
                                üí° Exemples: Document rejet√©, infos manquantes, prochaines √©tapes, etc.
                            </small>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-redo"></i> R√©initialiser
                            </button>
                            <button type="submit" class="btn btn-info text-white">
                                <i class="fas fa-paper-plane"></i> Envoyer le Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Info Box -->
        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h6 class="mb-0">üìã R√©sum√©</h6>
                </div>
                <div class="card-body">
                    <p class="mb-2">
                        <strong>Client:</strong> {{ reservation.client.prenom }} {{ reservation.client.nom }}
                    </p>
                    <p class="mb-2">
                        <strong>Email:</strong> <a href="mailto:{{ reservation.client.email }}">{{ reservation.client.email }}</a>
                    </p>
                    <p class="mb-2">
                        <strong>Statut Documents:</strong> 
                        {% if documents_complete %}
                            <span class="badge bg-success">‚úÖ Complet</span>
                        {% else %}
                            <span class="badge bg-warning">‚è≥ Incomplet</span>
                        {% endif %}
                    </p>
                    <hr>
                    <p class="text-muted small mb-0">
                        üí° Les messages seront archiv√©s √† titre de preuve de communication avec le client.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚öôÔ∏è Actions Disponibles</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Cr√©er Contrat -->
                        <div class="col-md-4 mb-3">
                            {% if can_sign_contrat %}
                                <a href="{% url 'commercial_contrat_create' reservation.id %}" class="btn btn-lg btn-warning w-100">
                                    <i class="fas fa-file-contract"></i><br>
                                    Cr√©er Contrat
                                </a>
                            {% else %}
                                {% if reservation.contrat %}
                                    <a href="{% url 'commercial_contrat_update' reservation.id %}" class="btn btn-lg btn-warning w-100">
                                        <i class="fas fa-edit"></i><br>
                                        Modifier le Contrat
                                    </a>
                                {% else %}
                                    <button class="btn btn-lg btn-secondary w-100" disabled>
                                        <i class="fas fa-check-circle"></i><br>
                                        Contrat Existant
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>

                        <!-- Valider Paiements -->
                        <div class="col-md-4 mb-3">
                            <a href="{% url 'commercial_payment_validation_list' %}?reservation={{ reservation.id }}" class="btn btn-lg btn-info w-100">
                                <i class="fas fa-check-double"></i><br>
                                Valider les Paiements
                            </a>
                        </div>

                        <!-- Annuler R√©servation -->
                        <div class="col-md-4 mb-3">
                            {% if reservation.can_cancel %}
                                <button type="button" class="btn btn-lg btn-danger w-100" data-bs-toggle="modal" data-bs-target="#cancelReservationModal">
                                    <i class="fas fa-times-circle"></i><br>
                                    Annuler R√©servation
                                </button>
                            {% else %}
                                <button class="btn btn-lg btn-secondary w-100" disabled title="Impossible d'annuler (contrat sign√© ou d√©j√† annul√©e)">
                                    <i class="fas fa-ban"></i><br>
                                    Annulation Impossible
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Annulation R√©servation -->
    <div class="modal fade" id="cancelReservationModal" tabindex="-1" role="dialog" aria-labelledby="cancelReservationLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelReservationLabel">
                        <i class="fas fa-exclamation-triangle"></i> Annuler la R√©servation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Attention !</strong><br>
                        Vous √™tes sur le point d'annuler la r√©servation de <strong>{{ reservation.client.prenom }} {{ reservation.client.nom }}</strong> pour l'unit√© <strong>{{ reservation.unite.reference_lot }}</strong>.
                        <br><br>
                        Cette action :
                        <ul>
                            <li>Rendra l'unit√© disponible pour d'autres clients</li>
                            <li>Marquera les paiements comme rejet√©s</li>
                            <li>Le client ne pourra plus modifier sa r√©servation</li>
                        </ul>
                    </div>
                    <form id="cancelReservationForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="cancelMotif" class="form-label"><strong>Motif de l'annulation <span class="text-danger">*</span></strong></label>
                            <textarea class="form-control" id="cancelMotif" name="motif" rows="4" placeholder="Expliquez la raison de l'annulation..." required></textarea>
                            <small class="text-muted">Ce motif sera enregistr√© dans le journal d'audit</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-check"></i> Confirmer l'Annulation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- D√©tails Financement et Contrat -->
    <div class="row">
        {% if reservation.financement %}
            <div class="col-md-6 mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üí∞ Financement</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">Banque:</td>
                                <td>{{ reservation.financement.banque.nom }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Type:</td>
                                <td>{{ reservation.financement.type }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Montant:</td>
                                <td><strong>{{ reservation.financement.montant|floatformat:0 }} FCFA</strong></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Statut:</td>
                                <td>
                                    <span class="badge bg-{% if reservation.financement.statut == 'accepte' %}success{% elif reservation.financement.statut == 'refuse' %}danger{% elif reservation.financement.statut == 'en_etude' %}info{% else %}warning{% endif %}">
                                        {{ reservation.financement.get_statut_display }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                        <a href="{% url 'commercial_financing_detail' reservation.financement.id %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-file-alt"></i> Voir les documents et statut
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if reservation.contrat %}
            <div class="col-md-6 mb-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">üìÑ Contrat</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold">Num√©ro:</td>
                                <td><code>{{ reservation.contrat.numero }}</code></td>
                            </tr>
                            <tr>
                                <td class="fw-bold">Statut:</td>
                                <td>
                                    <span class="badge bg-{% if reservation.contrat.statut == 'signe' %}success{% elif reservation.contrat.statut == 'annule' %}danger{% else %}warning{% endif %}">
                                        {{ reservation.contrat.get_statut_display }}
                                    </span>
                                </td>
                            </tr>
                            {% if reservation.contrat.signe_le %}
                                <tr>
                                    <td class="fw-bold">Sign√© le:</td>
                                    <td>{{ reservation.contrat.signe_le|date:"d/m/Y" }}</td>
                                </tr>
                            {% endif %}
                            {% if reservation.contrat.pdf %}
                                <tr>
                                    <td class="fw-bold">PDF:</td>
                                    <td><a href="{{ reservation.contrat.pdf.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> T√©l√©charger
                                    </a></td>
                                </tr>
                            {% endif %}
                        </table>
                        
                        <!-- Boutons OTP -->
                        {% if reservation.contrat.statut == 'brouillon' %}
                            <div class="d-flex gap-2">
                                <form method="post" action="{% url 'commercial_generate_otp' reservation.contrat.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="fas fa-lock"></i> G√©n√©rer OTP
                                    </button>
                                </form>
                                <a href="{% url 'commercial_contrat_update' reservation.id %}" class="btn btn-sm btn-outline-warning">
                                    <i class="fas fa-edit"></i> Mettre √† jour
                                </a>
                            </div>
                        {% else %}
                            <a href="{% url 'commercial_contrat_update' reservation.id %}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-edit"></i> Mettre √† jour
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Paiements -->
    {% if reservation.paiements.all %}
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üí≥ Paiements Enregistr√©s</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Montant</th>
                                        <th>Moyen</th>
                                        <th>Source</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for paiement in reservation.paiements.all %}
                                        <tr>
                                            <td>{{ paiement.date_paiement|date:"d/m/Y" }}</td>
                                            <td><strong>{{ paiement.montant|floatformat:0 }} FCFA</strong></td>
                                            <td>{{ paiement.get_moyen_display }}</td>
                                            <td>{{ paiement.source }}</td>
                                            <td>
                                                <span class="badge bg-{% if paiement.statut == 'valide' %}success{% elif paiement.statut == 'rejete' %}danger{% else %}warning{% endif %}">
                                                    {{ paiement.get_statut_display }}
                                                </span>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('confirmCancelBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            const motif = document.getElementById('cancelMotif').value.trim();
            
            if (!motif) {
                alert('Veuillez saisir le motif de l\'annulation.');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation? Cette action est irr√©versible.')) {
                // Envoyer la requ√™te API
                fetch(`/api/reservations/{{ reservation.id }}/cancel/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify({ motif: motif })
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.json().then(data => {
                            throw new Error(data.detail || 'Erreur lors de l\'annulation');
                        });
                    }
                })
                .then(data => {
                    alert('R√©servation annul√©e avec succ√®s!');
                    location.reload();
                })
                .catch(error => {
                    alert('Erreur: ' + error.message);
                });
            }
        });
    }
});
</script>
{% endblock %}

