{% extends 'base.html' %}
{% block content %}

<!-- Breadcrumbs -->
{% with breadcrumbs_list="Accueil,Programmes,Programme,Unit√©" %}
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Accueil</a></li>
      <li class="breadcrumb-item"><a href="{% url 'programme_list' %}" class="text-decoration-none">Programmes</a></li>
      <li class="breadcrumb-item"><a href="{% url 'programme_detail' unite.programme.pk %}" class="text-decoration-none">{{ unite.programme.nom }}</a></li>
      <li class="breadcrumb-item active">Unit√© {{ unite.reference_lot }}</li>
    </ol>
  </nav>
{% endwith %}

<!-- Header Unit√© -->
<div class="row mb-4">
  <div class="col-md-7">
    <h1 class="display-5 fw-bold">Unit√© {{ unite.reference_lot }}</h1>
    
    <!-- Infos programme et mod√®le -->
    <div class="mb-4">
      <p class="mb-2"><strong>üè¢ Programme :</strong> <a href="{% url 'programme_detail' unite.programme.pk %}" class="text-decoration-none">{{ unite.programme.nom }}</a></p>
      <p class="mb-2"><strong>üìê Mod√®le :</strong> {{ unite.modele_bien.nom_marketing }}</p>
      <p class="mb-2"><strong>üìç Adresse :</strong> {{ unite.programme.adresse }}</p>
    </div>

    <!-- Infos d√©tail -->
    <div class="row g-3 mb-4">
      <div class="col-sm-6">
        <div class="card border-0 bg-light">
          <div class="card-body">
            <small class="text-muted">Prix TTC</small>
            <h4 class="text-success fw-bold">{{ unite.prix_ttc|default:"N/A" }} FCFA</h4>
          </div>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="card border-0 bg-light">
          <div class="card-body">
            <small class="text-muted">Surface habitable</small>
            <h4 class="text-primary fw-bold">{{ unite.modele_bien.surface_hab_m2|default:"N/A" }} m¬≤</h4>
          </div>
        </div>
      </div>
    </div>

    <!-- Statut -->
    <div class="mb-4">
      <strong>√âtat de l'unit√© :</strong>
      {% with statut_reel=unite.get_statut_reel %}
        {% if statut_reel == 'disponible' %}
          <span class="badge bg-success fs-6">‚úì Disponible √† la r√©servation</span>
        {% elif statut_reel == 'reserve' %}
          <span class="badge bg-warning text-dark fs-6">‚è≥ R√©serv√©e</span>
        {% elif statut_reel == 'vendu' %}
          <span class="badge bg-danger fs-6">‚úï Vendue</span>
        {% else %}
          <span class="badge bg-secondary fs-6">üì¶ {{ unite.get_statut_disponibilite_display }}</span>
        {% endif %}
      {% endwith %}
    </div>

    <!-- Caract√©ristiques -->
    {% if unite.caracteristiques %}
      <div class="card border-0 bg-light mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">Caract√©ristiques</h5>
          <p class="card-text">{{ unite.caracteristiques|linebreaks }}</p>
        </div>
      </div>
    {% endif %}

    <!-- Boutons d'action -->
    <div class="d-grid gap-2 mb-4">
      {% if unite.statut_disponibilite == 'disponible' %}
        {% if user.is_authenticated %}
          <a href="{% url 'reserve_unite' unite.pk %}" class="btn btn-primary btn-lg">
            üîñ R√©server cette unit√©
          </a>
        {% else %}
          <a href="{% url 'reserve_unite' unite.pk %}" class="btn btn-primary btn-lg">
            üîñ R√©server cette unit√©
          </a>
        {% endif %}
      {% else %}
        <button class="btn btn-secondary btn-lg" disabled>
          Cette unit√© n'est pas disponible √† la r√©servation
        </button>
      {% endif %}
    </div>
  </div>

  <!-- Images et carte -->
  <div class="col-md-5">
    {% if unite.image %}
      <img src="{{ unite.image.url }}" class="img-fluid rounded shadow-sm mb-4" alt="{{ unite.reference_lot }}" style="max-height: 400px; width: 100%; object-fit: cover;">
    {% else %}
      <div class="bg-light rounded shadow-sm mb-4 d-flex align-items-center justify-content-center" style="height: 300px;">
        <span class="text-muted">üì¶ Pas d'image disponible</span>
      </div>
    {% endif %}
    
    {% if unite.gps_lat and unite.gps_lng %}
      <div id="unite-map" style="height: 300px;" class="rounded shadow-sm border"></div>
    {% endif %}
  </div>
</div>

<!-- Section suppl√©mentaire -->
<hr class="my-5">
<div class="row mb-4">
  <div class="col-md-12">
    <h3 class="mb-3">‚ÑπÔ∏è Informations suppl√©mentaires</h3>
    <div class="alert alert-info" role="alert">
      <p class="mb-0">
        Pour r√©server cette unit√© ou obtenir plus d'informations, connectez-vous √† votre compte 
        ou <a href="{% url 'register' %}" class="alert-link">cr√©ez un compte</a>.
      </p>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  {% if unite.gps_lat and unite.gps_lng %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <div id="unite-map" 
         data-lat="{{ unite.gps_lat }}" 
         data-lng="{{ unite.gps_lng }}" 
         data-lot="{{ unite.reference_lot }}" 
         data-program="{{ unite.programme.nom }}"></div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const mapElement = document.getElementById('unite-map');
        if (mapElement && typeof L !== 'undefined') {
          const lat = parseFloat(mapElement.dataset.lat);
          const lng = parseFloat(mapElement.dataset.lng);
          const lotRef = mapElement.dataset.lot;
          const programName = mapElement.dataset.program;
          
          const map2 = L.map('unite-map').setView([lat, lng], 17);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap'
          }).addTo(map2);
          L.marker([lat, lng]).addTo(map2)
            .bindPopup('<strong>Lot ' + lotRef + '</strong><br>' + programName)
            .openPopup();
        }
      });
    </script>
  {% endif %}
{% endblock %}
