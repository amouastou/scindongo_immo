{% extends 'base.html' %}

{% block content %}

<!-- Breadcrumbs -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Accueil</a></li>
    <li class="breadcrumb-item"><a href="{% url 'programme_list' %}">Programmes</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ programme.nom }}</li>
  </ol>
</nav>

<!-- Header Programme -->
<div class="row mb-4">
  <div class="col-md-7">
    <h1 class="display-5 fw-bold">{{ programme.nom }}</h1>
    <p class="lead text-muted">ğŸ“ {{ programme.adresse }}</p>
    <p class="mt-3">{{ programme.description }}</p>
    
    <!-- Infos complÃ©mentaires -->
    <div class="row g-2 mt-3">
      <div class="col-auto">
        <span class="badge bg-info">Notaire : {{ programme.notaire|default:"N/A" }}</span>
      </div>
      <div class="col-auto">
        <span class="badge bg-secondary">Contact : {{ programme.contact|default:"N/A" }}</span>
      </div>
      <div class="col-auto">
        {% if programme.statut == 'actif' %}
          <span class="badge bg-success">âœ“ Actif</span>
        {% elif programme.statut == 'brouillon' %}
          <span class="badge bg-warning text-dark">â³ Brouillon</span>
        {% else %}
          <span class="badge bg-secondary">ğŸ“¦ ArchivÃ©</span>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-5">
    {% if programme.image_principale %}
      <img src="{{ programme.image_principale.url }}" class="img-fluid rounded shadow-sm mb-3" alt="{{ programme.nom }}" style="max-height: 300px; object-fit: cover; width: 100%;">
    {% else %}
      <div class="bg-light rounded shadow-sm mb-3 d-flex align-items-center justify-content-center" style="height: 300px;">
        <span class="text-muted">ğŸ¢ Pas d'image disponible</span>
      </div>
    {% endif %}
    <div id="programme-map" 
         data-lat="{{ programme.gps_lat }}" 
         data-lng="{{ programme.gps_lng }}" 
         data-name="{{ programme.nom|escapejs }}" 
         data-address="{{ programme.adresse|escapejs }}"
         style="height: 250px;" 
         class="rounded border shadow-sm"></div>
  </div>
</div>

<hr class="my-5">

<!-- UnitÃ©s du programme -->
<h2 class="mb-4">UnitÃ©s disponibles</h2>

{% if programme.unites.all %}
  <div class="row g-4">
    {% for unite in programme.unites.all %}
      <div class="col-lg-4">
        <div class="card shadow-sm h-100 border-0">
          {% if unite.image %}
            <img src="{{ unite.image.url }}" class="card-img-top" alt="{{ unite.reference_lot }}" style="height: 200px; object-fit: cover;">
          {% else %}
            <div class="bg-light" style="height: 200px; display: flex; align-items: center; justify-content: center;">
              <span class="text-muted">ğŸ“¦ Pas d'image</span>
            </div>
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-primary fw-bold">{{ unite.reference_lot }}</h5>
            <p class="card-text text-muted small">{{ unite.modele_bien.nom_marketing }}</p>
            
            <!-- DÃ©tails prix et surface -->
            <div class="mb-3">
              <p class="mb-1"><strong>ğŸ’° Prix TTC :</strong> <span class="text-success fw-bold">{{ unite.prix_ttc|default:"N/A" }} FCFA</span></p>
              <p class="mb-0"><strong>ğŸ“ Surface :</strong> {{ unite.modele_bien.surface_hab_m2|default:"N/A" }} mÂ²</p>
            </div>

            <!-- Statut -->
            <div class="mb-3">
              {% if unite.statut_disponibilite == 'disponible' %}
                <span class="badge bg-success">âœ“ Disponible</span>
              {% elif unite.statut_disponibilite == 'reserve' %}
                <span class="badge bg-warning text-dark">â³ RÃ©servÃ©e</span>
              {% elif unite.statut_disponibilite == 'vendu' %}
                <span class="badge bg-danger">âœ• Vendue</span>
              {% else %}
                <span class="badge bg-secondary">ğŸ“¦ {{ unite.get_statut_disponibilite_display }}</span>
              {% endif %}
            </div>

            <!-- Boutons d'action -->
            <div class="d-grid gap-2 mt-auto">
              <a href="{% url 'unite_detail' unite.pk %}" class="btn btn-outline-primary btn-sm">
                ğŸ“‹ Voir le dÃ©tail
              </a>
              {% if unite.statut_disponibilite == 'disponible' and user.is_authenticated %}
                <a href="{% url 'reserve_unite' unite.pk %}" class="btn btn-primary btn-sm">
                  ğŸ”– RÃ©server
                </a>
              {% elif not user.is_authenticated and unite.statut_disponibilite == 'disponible' %}
                <a href="{% url 'reserve_unite' unite.pk %}" class="btn btn-primary btn-sm">
                  ğŸ”– RÃ©server
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="alert alert-info" role="alert">
    <h5 class="alert-heading">Aucune unitÃ© disponible</h5>
    <p class="mb-0">Les unitÃ©s de ce programme seront bientÃ´t disponibles.</p>
  </div>
{% endif %}

{% endblock %}

{% block extra_js %}
{% if programme.gps_lat and programme.gps_lng %}
<script>
  // Initialiser la carte aprÃ¨s le chargement de la page
  document.addEventListener('DOMContentLoaded', function() {
    const mapElement = document.getElementById('programme-map');
    if (mapElement && typeof L !== 'undefined') {
      const lat = parseFloat(mapElement.dataset.lat);
      const lng = parseFloat(mapElement.dataset.lng);
      const programName = mapElement.dataset.name;
      const programAddress = mapElement.dataset.address;
      
      const map = L.map('programme-map').setView([lat, lng], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      L.marker([lat, lng]).addTo(map)
        .bindPopup('<strong>' + programName + '</strong><br>' + programAddress)
        .openPopup();
    }
  });
</script>
{% endif %}
{% endblock %}
