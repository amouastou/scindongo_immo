{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Header Dashboard -->
<div class="mb-4">
  <h1 class="display-6 fw-bold">ğŸ“Š Tableau de bord commercial</h1>
  <p class="lead text-muted">Suivi global des ventes, clients et financements</p>
</div>

<!-- Statistiques principales -->
<div class="row g-3 mb-5">
  <div class="col-lg-3">
    <a href="{% url 'commercial_client_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-primary text-white h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">Clients</h6>
          <h2 class="display-5 fw-bold">{{ clients_count }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-lg-3">
    <a href="{% url 'commercial_reservation_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-success text-white h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">RÃ©servations</h6>
          <h2 class="display-5 fw-bold">{{ reservations_count }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-lg-3">
    <div class="card border-0 bg-info text-white h-100">
      <div class="card-body">
        <h6 class="card-title text-uppercase fw-bold small">Paiements</h6>
        <h2 class="display-5 fw-bold">{{ paiements_count }}</h2>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card border-0 bg-warning text-dark h-100">
      <div class="card-body">
        <h6 class="card-title text-uppercase fw-bold small">Financements</h6>
        <h2 class="display-5 fw-bold">{{ financements_count }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Actions principales -->
<div class="row g-3 mb-5">
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_client_create' %}" class="btn btn-primary btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-user-plus fs-4"></i></div>
      <div class="fw-bold mt-2">CrÃ©er un Client</div>
      <small class="text-white">Ajouter un nouveau client</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_reservation_list' %}" class="btn btn-success btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-bookmark fs-4"></i></div>
      <div class="fw-bold mt-2">Gerer RÃ©servations</div>
      <small class="text-white">Suivi des rÃ©servations</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_client_list' %}" class="btn btn-info btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-users fs-4"></i></div>
      <div class="fw-bold mt-2">Mes Clients</div>
      <small class="text-white">Gestion des clients</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="#financements-content" onclick="document.getElementById('financements-tab').click(); return false;" class="btn btn-warning btn-lg w-100 text-start p-3" style="text-decoration: none; color: #000;">
      <div><i class="fas fa-hand-holding-usd fs-4"></i></div>
      <div class="fw-bold mt-2">Financements</div>
      <small>Suivi des crÃ©dits</small>
    </a>
  </div>
</div>

<!-- Onglets de contenu -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="reservations-tab" data-bs-toggle="tab" data-bs-target="#reservations-content" type="button" role="tab">
      ğŸ“‹ RÃ©servations
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-content" type="button" role="tab">
      ğŸ‘¥ Clients
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="paiements-tab" data-bs-toggle="tab" data-bs-target="#paiements-content" type="button" role="tab">
      ğŸ’³ Paiements
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="financements-tab" data-bs-toggle="tab" data-bs-target="#financements-content" type="button" role="tab">
      ğŸ¦ Financements
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="programmes-tab" data-bs-toggle="tab" data-bs-target="#programmes-content" type="button" role="tab">
      ğŸ—ï¸ Programmes
    </button>
  </li>
</ul>

<div class="tab-content">

  <!-- Onglet RÃ©servations -->
  <div class="tab-pane fade show active" id="reservations-content" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>RÃ©capitulatif des rÃ©servations</h3>
      <a href="{% url 'commercial_reservation_list' %}" class="btn btn-sm btn-primary">Voir Tout</a>
    </div>
    {% if reservations %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Client</th>
              <th>UnitÃ©</th>
              <th>Programme</th>
              <th>Acompte</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for res in reservations %}
              <tr>
                  <td>
                    {{ res.client.prenom }} {{ res.client.nom }}<br>
                    <small class="text-muted">{{ res.client.email }}</small>
                  </td>
                <td><strong>{{ res.unite.reference }}</strong></td>
                <td>{{ res.unite.programme.nom }}</td>
                <td class="fw-bold">{{ res.acompte|floatformat:0 }} FCFA</td>
                <td>
                  {% if res.statut == 'en_cours' %}
                    <span class="badge bg-warning text-dark">â³ En cours</span>
                  {% elif res.statut == 'confirmee' %}
                    <span class="badge bg-success">âœ“ ConfirmÃ©e</span>
                  {% elif res.statut == 'annulee' %}
                    <span class="badge bg-danger">âœ• AnnulÃ©e</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ res.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>{{ res.created_at|date:"d/m/Y" }}</td>
                <td>
                  <a href="{% url 'commercial_reservation_detail' res.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i> DÃ©tail
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucune rÃ©servation.</div>
    {% endif %}
  </div>

  <!-- Onglet Clients -->
  <div class="tab-pane fade" id="clients-content" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Liste des clients</h3>
      <a href="{% url 'commercial_client_create' %}" class="btn btn-sm btn-primary">
        <i class="fas fa-plus"></i> Ajouter un Client
      </a>
    </div>
    {% if clients %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>TÃ©lÃ©phone</th>
              <th>RÃ©servations</th>
              <th>KYC</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for client in clients %}
              <tr>
                <td>
                  <strong>{{ client.prenom }} {{ client.nom }}</strong>
                </td>
                <td>{{ client.email }}</td>
                <td>{{ client.telephone|default:"N/A" }}</td>
                <td>{{ client.reservations.count }}</td>
                <td>
                  {% if client.kyc_statut %}
                    <span class="badge bg-info">{{ client.kyc_statut }}</span>
                  {% else %}
                    <span class="badge bg-warning">Non renseignÃ©</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'commercial_client_update' client.id %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i> Modifier
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun client.</div>
    {% endif %}
  </div>

  <!-- Onglet Paiements -->
  <div class="tab-pane fade" id="paiements-content" role="tabpanel">
    <h3 class="mb-3">Suivi des paiements</h3>
    {% if paiements %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Montant</th>
              <th>Moyen</th>
              <th>Statut</th>
              <th>RÃ©servation</th>
            </tr>
          </thead>
          <tbody>
            {% for p in paiements %}
              <tr>
                <td>{{ p.date_paiement|date:"d/m/Y" }}</td>
                <td>
                  {% if p.reservation and p.reservation.client and p.reservation.client.user %}
                    {% if p.reservation and p.reservation.client and p.reservation.client.user %}
                      {% if p.reservation.client.user.get_full_name %}
                        {{ p.reservation.client.user.get_full_name }}
                      {% else %}
                        {{ p.reservation.client.user.email }}
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td class="fw-bold text-success">{{ p.montant }} FCFA</td>
                <td>
                  {% if p.moyen == 'virement' %}
                    ğŸ¦ Virement
                  {% elif p.moyen == 'cheque' %}
                    ğŸ“‹ ChÃ¨que
                  {% elif p.moyen == 'espece' %}
                    ğŸ’µ EspÃ¨ce
                  {% else %}
                    {{ p.get_moyen_display }}
                  {% endif %}
                </td>
                <td>
                  {% if p.statut == 'enregistre' %}
                    <span class="badge bg-info">â³ EnregistrÃ©</span>
                  {% elif p.statut == 'valide' %}
                    <span class="badge bg-success">âœ“ ValidÃ©</span>
                  {% elif p.statut == 'rejete' %}
                    <span class="badge bg-danger">âœ• RejetÃ©</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ p.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>{{ p.reservation.unite.reference_lot }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun paiement.</div>
    {% endif %}
  </div>

  <!-- Onglet Financements -->
  <div class="tab-pane fade" id="financements-content" role="tabpanel">
    <h3 class="mb-3">Suivi des financements</h3>
    {% if financements %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Banque</th>
              <th>Type</th>
              <th>Montant</th>
              <th>Taux</th>
              <th>Statut</th>
              <th>Client</th>
            </tr>
          </thead>
          <tbody>
            {% for f in financements %}
              <tr>
                <td><strong>{{ f.banque_partenaire.nom }}</strong></td>
                <td>{{ f.get_type_display }}</td>
                <td class="fw-bold">{{ f.montant }} FCFA</td>
                <td>{{ f.taux }}%</td>
                <td>
                  {% if f.statut == 'soumis' %}
                    <span class="badge bg-info">ğŸ“® Soumis</span>
                  {% elif f.statut == 'en_etude' %}
                    <span class="badge bg-warning text-dark">ğŸ“š En Ã©tude</span>
                  {% elif f.statut == 'accepte' %}
                    <span class="badge bg-success">âœ“ AcceptÃ©</span>
                  {% elif f.statut == 'refuse' %}
                    <span class="badge bg-danger">âœ• RefusÃ©</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ f.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if f.reservation and f.reservation.client and f.reservation.client.user %}
                    {% if f.reservation and f.reservation.client and f.reservation.client.user %}
                      {% if f.reservation.client.user.get_full_name %}
                        {{ f.reservation.client.user.get_full_name }}
                      {% else %}
                        {{ f.reservation.client.user.email }}
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun financement.</div>
    {% endif %}
  </div>

  <!-- Onglet Programmes -->
  <div class="tab-pane fade" id="programmes-content" role="tabpanel">
    <h3 class="mb-3">Suivi des programmes</h3>
    {% if programmes %}
      <div class="row g-3">
        {% for prog in programmes %}
          <div class="col-lg-6">
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title fw-bold">{{ prog.nom }}</h5>
                <p class="card-text text-muted small">{{ prog.adresse }}</p>
                <div class="row g-2 small mb-3">
                  <div class="col-6">
                    <strong>UnitÃ©s totales :</strong> {{ prog.unites.count }}
                  </div>
                  <div class="col-6">
                    <strong>RÃ©servÃ©es :</strong> {{ prog.unites_reservees_count|default:0 }}
                  </div>
                  <div class="col-6">
                    <strong>Vendues :</strong> {{ prog.unites_vendues_count|default:0 }}
                  </div>
                  <div class="col-6">
                    <strong>Statut :</strong> 
                    {% if prog.statut == 'actif' %}
                      <span class="badge bg-success">Actif</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ prog.get_statut_display }}</span>
                    {% endif %}
                  </div>
                </div>
                <a href="{% url 'programme_detail' prog.pk %}" class="btn btn-sm btn-outline-primary">Voir programme</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info">Aucun programme.</div>
    {% endif %}
  </div>

</div>

{% endblock %}
