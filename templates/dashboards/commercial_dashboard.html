{% extends 'base.html' %}
{% load static %}

{% block content %}

<!-- Header Dashboard -->
<div class="mb-4">
  <h1 class="display-6 fw-bold">ğŸ“Š Tableau de bord commercial</h1>
  <p class="lead text-muted">Suivi global des ventes, clients et financements</p>
</div>

<!-- Statistiques principales -->
<div class="row g-3 mb-5">
  <div class="col-lg-3">
    <a href="{% url 'commercial_client_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-primary text-white h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">Clients</h6>
          <h2 class="display-5 fw-bold">{{ clients_count }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-lg-3">
    <a href="{% url 'commercial_reservation_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-success text-white h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">RÃ©servations</h6>
          <h2 class="display-5 fw-bold">{{ reservations_count }}</h2>
        </div>
      </div>
    </a>
  </div>
  <div class="col-lg-3">
    <div class="card border-0 bg-info text-white h-100">
      <div class="card-body">
        <h6 class="card-title text-uppercase fw-bold small">Paiements</h6>
        <h2 class="display-5 fw-bold">{{ paiements_count }}</h2>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card border-0 bg-warning text-dark h-100">
      <div class="card-body">
        <h6 class="card-title text-uppercase fw-bold small">Financements</h6>
        <h2 class="display-5 fw-bold">{{ financements_count }}</h2>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <a href="{% url 'banque_partenaire_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-light text-dark h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">Banques</h6>
          <h2 class="display-5 fw-bold">ğŸ¦</h2>
          <div class="small text-muted">GÃ©rer les banques partenaires</div>
        </div>
      </div>
    </a>
  </div>
  <div class="col-lg-3">
    <a href="{% url 'commercial_financing_list' %}" class="text-decoration-none">
      <div class="card border-0 bg-success text-white h-100" style="cursor: pointer; transition: transform 0.2s;">
        <div class="card-body">
          <h6 class="card-title text-uppercase fw-bold small">Financement</h6>
          <h2 class="display-5 fw-bold">ğŸ’°</h2>
          <div class="small">GÃ©rer les demandes</div>
        </div>
      </div>
    </a>
  </div>
</div>

<!-- Ã‰TAPE 3: RÃ©servations en attente (PRIORITÃ‰ HAUTE) -->
{% if pending_count > 0 %}
<div class="alert alert-danger alert-dismissible fade show mb-5" role="alert">
  <div class="d-flex align-items-center">
    <div class="me-3">
      <i class="fas fa-clock fa-2x"></i>
    </div>
    <div>
      <h4 class="alert-heading">âš ï¸ RÃ©servations En Attente de Validation</h4>
      <p class="mb-0">Vous avez <strong>{{ pending_count }} rÃ©servation(s)</strong> Ã  confirmer.</p>
      <p class="mb-0 mt-2">Les clients sont en attente de votre validation commerciale avant de pouvoir procÃ©der au paiement.</p>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
</div>

<!-- Tableau des rÃ©servations en attente -->
<div class="card mb-5 border-danger">
  <div class="card-header bg-danger text-white">
    <h5 class="mb-0">ğŸ”” RÃ©servations En Attente ({{ pending_count }})</h5>
  </div>
  <div class="card-body">
    {% if pending_reservations %}
      <div class="table-responsive">
        <table class="table table-hover table-sm table-striped">
          <thead class="table-light">
            <tr>
              <th>Client</th>
              <th>TÃ©lÃ©phone</th>
              <th>UnitÃ©</th>
              <th>Acompte</th>
              <th>Date RÃ©servation</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for res in pending_reservations %}
              <tr class="border-start border-danger border-5">
                <td>
                  <strong>{{ res.client.prenom }} {{ res.client.nom }}</strong><br>
                  <small class="text-muted">{{ res.client.email }}</small>
                </td>
                <td>{{ res.client.telephone }}</td>
                <td>
                  <strong>{{ res.unite.reference }}</strong><br>
                  <small class="text-muted">{{ res.unite.programme.nom }} - {{ res.unite.modele.nom }}</small>
                </td>
                <td class="fw-bold text-success">{{ res.acompte|floatformat:0 }} FCFA</td>
                <td>{{ res.created_at|date:"d/m/Y" }}</td>
                <td>
                  <a href="{% url 'commercial_reservation_detail' res.id %}" class="btn btn-sm btn-info">
                    <i class="fas fa-eye"></i> Voir
                  </a>
                  <a href="{% url 'commercial_reservation_confirm' res.id %}" class="btn btn-sm btn-success">
                    <i class="fas fa-check"></i> Confirmer
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-success mb-0">
        <i class="fas fa-check-circle"></i> Aucune rÃ©servation en attente. Excellent travail !
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Ã‰TAPE 8: Paiements en attente de validation -->
{% if pending_payments_count > 0 %}
<div class="alert alert-warning alert-dismissible fade show mb-5" role="alert">
  <div class="d-flex align-items-center">
    <div class="me-3">
      <i class="fas fa-credit-card fa-2x"></i>
    </div>
    <div>
      <h4 class="alert-heading">âš ï¸ Paiements En Attente de Validation</h4>
      <p class="mb-0">Vous avez <strong>{{ pending_payments_count }} paiement(s)</strong> Ã  valider.</p>
      <p class="mb-0 mt-2">Les clients attendent la confirmation de leurs paiements avant de gÃ©nÃ©rer les contrats.</p>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
</div>

<!-- Tableau des paiements en attente -->
<div class="card mb-5 border-warning">
  <div class="card-header bg-warning text-dark">
    <h5 class="mb-0">ğŸ’³ Paiements En Attente ({{ pending_payments_count }})</h5>
  </div>
  <div class="card-body">
    {% if pending_payments %}
      <div class="table-responsive">
        <table class="table table-hover table-sm table-striped">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>UnitÃ©</th>
              <th>Montant</th>
              <th>Moyen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in pending_payments %}
              <tr class="border-start border-warning border-5">
                <td>
                  <strong>{{ payment.created_at|date:"d/m/Y" }}</strong><br>
                  <small class="text-muted">{{ payment.created_at|time:"H:i" }}</small>
                </td>
                <td>
                  <strong>{{ payment.reservation.client.prenom }} {{ payment.reservation.client.nom }}</strong><br>
                  <small class="text-muted">{{ payment.reservation.client.email }}</small>
                </td>
                <td>
                  <strong>{{ payment.reservation.unite.reference }}</strong><br>
                  <small class="text-muted">{{ payment.reservation.unite.programme.nom }}</small>
                </td>
                <td class="fw-bold text-success">{{ payment.montant|floatformat:0 }} FCFA</td>
                <td>
                  {% if payment.moyen == 'virement' %}
                    ğŸ¦ Virement
                  {% elif payment.moyen == 'cheque' %}
                    ğŸ’³ ChÃ¨que
                  {% elif payment.moyen == 'espece' %}
                    ğŸ’µ EspÃ¨ces
                  {% elif payment.moyen == 'carte' %}
                    ğŸ’³ Carte
                  {% else %}
                    {{ payment.moyen }}
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'commercial_payment_validation_list' %}" class="btn btn-sm btn-warning">
                    <i class="fas fa-list"></i> Voir Tous
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-end mt-2">
        <a href="{% url 'commercial_payment_validation_list' %}" class="btn btn-warning">
          <i class="fas fa-arrow-right"></i> Valider les Paiements
        </a>
      </div>
    {% else %}
      <div class="alert alert-success mb-0">
        <i class="fas fa-check-circle"></i> Aucun paiement en attente. Excellent travail !
      </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Actions principales -->
<div class="row g-3 mb-5">
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_client_create' %}" class="btn btn-primary btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-user-plus fs-4"></i></div>
      <div class="fw-bold mt-2">CrÃ©er un Client</div>
      <small class="text-white">Ajouter un nouveau client</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_reservation_list' %}" class="btn btn-success btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-bookmark fs-4"></i></div>
      <div class="fw-bold mt-2">Gerer RÃ©servations</div>
      <small class="text-white">Suivi des rÃ©servations</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="{% url 'commercial_client_list' %}" class="btn btn-info btn-lg w-100 text-start p-3" style="text-decoration: none;">
      <div><i class="fas fa-users fs-4"></i></div>
      <div class="fw-bold mt-2">Mes Clients</div>
      <small class="text-white">Gestion des clients</small>
    </a>
  </div>
  <div class="col-md-6 col-lg-3">
    <a href="#financements-content" onclick="document.getElementById('financements-tab').click(); return false;" class="btn btn-warning btn-lg w-100 text-start p-3" style="text-decoration: none; color: #000;">
      <div><i class="fas fa-hand-holding-usd fs-4"></i></div>
      <div class="fw-bold mt-2">Financements</div>
      <small>Suivi des crÃ©dits</small>
    </a>
  </div>
</div>

<!-- Onglets de contenu -->
<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="reservations-tab" data-bs-toggle="tab" data-bs-target="#reservations-content" type="button" role="tab">
      ğŸ“‹ RÃ©servations
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients-content" type="button" role="tab">
      ğŸ‘¥ Clients
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="paiements-tab" data-bs-toggle="tab" data-bs-target="#paiements-content" type="button" role="tab">
      ğŸ’³ Paiements
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="financements-tab" data-bs-toggle="tab" data-bs-target="#financements-content" type="button" role="tab">
      ğŸ¦ Financements
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="programmes-tab" data-bs-toggle="tab" data-bs-target="#programmes-content" type="button" role="tab">
      ğŸ—ï¸ Programmes
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="chantiers-tab" data-bs-toggle="tab" data-bs-target="#chantiers-content" type="button" role="tab">
      ğŸ—ï¸ Gestion Chantiers
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="profil-tab" data-bs-toggle="tab" data-bs-target="#profil-content" type="button" role="tab">
      ğŸ‘¤ Mon profil
    </button>
  </li>
</ul>

<div class="tab-content">

  <!-- Onglet RÃ©servations -->
  <div class="tab-pane fade show active" id="reservations-content" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>RÃ©capitulatif des rÃ©servations</h3>
      <a href="{% url 'commercial_reservation_list' %}" class="btn btn-sm btn-primary">Voir Tout</a>
    </div>
    {% if reservations %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Client</th>
              <th>UnitÃ©</th>
              <th>Programme</th>
              <th>Acompte</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for res in reservations %}
              <tr>
                  <td>
                    {{ res.client.prenom }} {{ res.client.nom }}<br>
                    <small class="text-muted">{{ res.client.email }}</small>
                  </td>
                <td><strong>{{ res.unite.reference }}</strong></td>
                <td>{{ res.unite.programme.nom }}</td>
                <td class="fw-bold">{{ res.acompte|floatformat:0 }} FCFA</td>
                <td>
                  {% if res.statut == 'en_cours' %}
                    <span class="badge bg-warning text-dark">â³ En cours</span>
                  {% elif res.statut == 'confirmee' %}
                    <span class="badge bg-success">âœ“ ConfirmÃ©e</span>
                  {% elif res.statut == 'annulee' %}
                    <span class="badge bg-danger">âœ• AnnulÃ©e</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ res.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>{{ res.created_at|date:"d/m/Y" }}</td>
                <td>
                  <a href="{% url 'commercial_reservation_detail' res.id %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i> DÃ©tail
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucune rÃ©servation.</div>
    {% endif %}
  </div>

  <!-- Onglet Clients -->
  <div class="tab-pane fade" id="clients-content" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Liste des clients</h3>
      <a href="{% url 'commercial_client_create' %}" class="btn btn-sm btn-primary">
        <i class="fas fa-plus"></i> Ajouter un Client
      </a>
    </div>
    {% if clients %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>TÃ©lÃ©phone</th>
              <th>RÃ©servations</th>
              <th>KYC</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for client in clients %}
              <tr>
                <td>
                  <strong>{{ client.prenom }} {{ client.nom }}</strong>
                </td>
                <td>{{ client.email }}</td>
                <td>{{ client.telephone|default:"N/A" }}</td>
                <td>{{ client.reservations.count }}</td>
                <td>
                  {% if client.kyc_statut %}
                    <span class="badge bg-info">{{ client.kyc_statut }}</span>
                  {% else %}
                    <span class="badge bg-warning">Non renseignÃ©</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'commercial_client_update' client.id %}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit"></i> Modifier
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun client.</div>
    {% endif %}
  </div>

  <!-- Onglet Paiements -->
  <div class="tab-pane fade" id="paiements-content" role="tabpanel">
    <h3 class="mb-3">Suivi des paiements</h3>
    {% if paiements %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Montant</th>
              <th>Moyen</th>
              <th>Statut</th>
              <th>RÃ©servation</th>
            </tr>
          </thead>
          <tbody>
            {% for p in paiements %}
              <tr>
                <td>{{ p.date_paiement|date:"d/m/Y" }}</td>
                <td>
                  {% if p.reservation and p.reservation.client and p.reservation.client.user %}
                    {% if p.reservation and p.reservation.client and p.reservation.client.user %}
                      {% if p.reservation.client.user.get_full_name %}
                        {{ p.reservation.client.user.get_full_name }}
                      {% else %}
                        {{ p.reservation.client.user.email }}
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td class="fw-bold text-success">{{ p.montant }} FCFA</td>
                <td>
                  {% if p.moyen == 'virement' %}
                    ğŸ¦ Virement
                  {% elif p.moyen == 'cheque' %}
                    ğŸ“‹ ChÃ¨que
                  {% elif p.moyen == 'espece' %}
                    ğŸ’µ EspÃ¨ce
                  {% else %}
                    {{ p.get_moyen_display }}
                  {% endif %}
                </td>
                <td>
                  {% if p.statut == 'enregistre' %}
                    <span class="badge bg-info">â³ EnregistrÃ©</span>
                  {% elif p.statut == 'valide' %}
                    <span class="badge bg-success">âœ“ ValidÃ©</span>
                  {% elif p.statut == 'rejete' %}
                    <span class="badge bg-danger">âœ• RejetÃ©</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ p.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>{{ p.reservation.unite.reference_lot }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun paiement.</div>
    {% endif %}
  </div>

  <!-- Onglet Financements -->
  <div class="tab-pane fade" id="financements-content" role="tabpanel">
    <h3 class="mb-3">Suivi des financements</h3>
    {% if financements %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>Banque</th>
              <th>Type</th>
              <th>Montant</th>
              <th>Taux</th>
              <th>Statut</th>
              <th>Client</th>
            </tr>
          </thead>
          <tbody>
            {% for f in financements %}
              <tr>
                <td><strong>{{ f.banque_partenaire.nom }}</strong></td>
                <td>{{ f.get_type_display }}</td>
                <td class="fw-bold">{{ f.montant }} FCFA</td>
                <td>{{ f.taux }}%</td>
                <td>
                  {% if f.statut == 'soumis' %}
                    <span class="badge bg-info">ğŸ“® Soumis</span>
                  {% elif f.statut == 'en_etude' %}
                    <span class="badge bg-warning text-dark">ğŸ“š En Ã©tude</span>
                  {% elif f.statut == 'accepte' %}
                    <span class="badge bg-success">âœ“ AcceptÃ©</span>
                  {% elif f.statut == 'refuse' %}
                    <span class="badge bg-danger">âœ• RefusÃ©</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ f.get_statut_display }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if f.reservation and f.reservation.client and f.reservation.client.user %}
                    {% if f.reservation and f.reservation.client and f.reservation.client.user %}
                      {% if f.reservation.client.user.get_full_name %}
                        {{ f.reservation.client.user.get_full_name }}
                      {% else %}
                        {{ f.reservation.client.user.email }}
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">Aucun financement.</div>
    {% endif %}
  </div>

  <!-- Onglet Programmes -->
  <div class="tab-pane fade" id="programmes-content" role="tabpanel">
    <h3 class="mb-3">Suivi des programmes</h3>
    {% if programmes %}
      <div class="row g-3">
        {% for prog in programmes %}
          <div class="col-lg-6">
            <div class="card shadow-sm border-0">
              <div class="card-body">
                <h5 class="card-title fw-bold">{{ prog.nom }}</h5>
                <p class="card-text text-muted small">{{ prog.adresse }}</p>
                <div class="row g-2 small mb-3">
                  <div class="col-6">
                    <strong>UnitÃ©s totales :</strong> {{ prog.unites.count }}
                  </div>
                  <div class="col-6">
                    <strong>RÃ©servÃ©es :</strong> {{ prog.unites_reservees_count|default:0 }}
                  </div>
                  <div class="col-6">
                    <strong>Vendues :</strong> {{ prog.unites_vendues_count|default:0 }}
                  </div>
                  <div class="col-6">
                    <strong>Statut :</strong> 
                    {% if prog.statut == 'actif' %}
                      <span class="badge bg-success">Actif</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ prog.get_statut_display }}</span>
                    {% endif %}
                  </div>
                </div>
                <a href="{% url 'programme_detail' prog.pk %}" class="btn btn-sm btn-outline-primary">Voir programme</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="alert alert-info">Aucun programme.</div>
    {% endif %}
  </div>

  <!-- Onglet Gestion Chantiers -->
  <div class="tab-pane fade" id="chantiers-content" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>ğŸ—ï¸ Gestion des Chantiers par UnitÃ©</h3>
      <a href="{% url 'chantiers_unites_list' %}" class="btn btn-sm btn-primary">
        <i class="fas fa-plus"></i> GÃ©rer Chantiers
      </a>
    </div>
    
    {% if chantiers_unites %}
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-light">
            <tr>
              <th>UnitÃ©</th>
              <th>Programme</th>
              <th>Statut Chantier</th>
              <th>Progression</th>
              <th>Dernier Avancement</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for unite in chantiers_unites %}
              <tr>
                <td><strong>{{ unite.reference_lot }}</strong></td>
                <td>{{ unite.programme.nom }}</td>
                <td>
                  {% if unite.statut_chantier == 'non_commence' %}
                    <span class="badge bg-secondary">â¹ï¸ Non commencÃ©</span>
                  {% elif unite.statut_chantier == 'en_cours' %}
                    <span class="badge bg-warning text-dark">ğŸ”„ En cours</span>
                  {% elif unite.statut_chantier == 'termine' %}
                    <span class="badge bg-success">âœ“ TerminÃ©</span>
                  {% elif unite.statut_chantier == 'livre' %}
                    <span class="badge bg-info">ğŸ“¦ LivrÃ©</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ unite.get_statut_chantier_display }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if unite.avancements_chantier.exists %}
                    {% with dernier=unite.avancements_chantier.first %}
                      <div style="width: 100px;">
                        <div class="progress" style="height: 20px;">
                          <div class="progress-bar" data-percentage="{{ dernier.pourcentage }}" style="width: 0%;">
                            {{ dernier.pourcentage }}%
                          </div>
                        </div>
                      </div>
                    {% endwith %}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td>
                  {% if unite.avancements_chantier.exists %}
                    {% with dernier=unite.avancements_chantier.first %}
                      <small class="text-muted">
                        {{ dernier.etape }}<br>
                        <strong>{{ dernier.date_pointage|date:"d/m/Y" }}</strong>
                      </small>
                    {% endwith %}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td>
                  {% if unite.avancements_chantier.exists %}
                    {% with dernier=unite.avancements_chantier.first %}
                      <a href="{% url 'avancement_detail' dernier.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> DÃ©tail
                      </a>
                    {% endwith %}
                  {% else %}
                    <a href="{% url 'avancement_create' %}?unite={{ unite.pk }}" class="btn btn-sm btn-outline-success">
                      <i class="fas fa-plus"></i> Ajouter
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Aucune unitÃ© en chantier. Les unitÃ©s rÃ©servÃ©es ou vendues apparaÃ®tront ici.
      </div>
    {% endif %}
  </div>

  <!-- Onglet Mon profil -->
  <div class="tab-pane fade" id="profil-content" role="tabpanel">
    <h3 class="mb-3">Mon profil</h3>
    <div class="row">
      <div class="col-md-6">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-3">Informations personnelles</h5>
            <dl class="row mb-0">
              <dt class="col-sm-4">PrÃ©nom :</dt>
              <dd class="col-sm-8">{{ user.first_name|default:"Non renseignÃ©" }}</dd>

              <dt class="col-sm-4">Nom :</dt>
              <dd class="col-sm-8">{{ user.last_name|default:"Non renseignÃ©" }}</dd>

              <dt class="col-sm-4">Email :</dt>
              <dd class="col-sm-8">{% if user and user.email %}{{ user.email }}{% else %}<span class="text-muted">Non renseignÃ©</span>{% endif %}</dd>

              <dt class="col-sm-4">TÃ©lÃ©phone :</dt>
              <dd class="col-sm-8">
                {% if user.telephone %}
                  {{ user.telephone }}
                {% else %}
                  <span class="text-muted">Non renseignÃ©</span>
                {% endif %}
              </dd>
            </dl>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-3">Actions</h5>
            <div class="d-grid gap-2">
              <a href="{% url 'commercial_edit_profile' %}" class="btn btn-outline-primary">ğŸ“ Modifier mon profil</a>
              <a href="{% url 'commercial_change_password' %}" class="btn btn-outline-secondary">ğŸ” Changer mon mot de passe</a>
              <form method="post" action="{% url 'logout' %}" class="d-grid">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger">ğŸšª Se dÃ©connecter</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

</div>

{% endblock %}

<script>
  /*<![CDATA[*/
  document.addEventListener('DOMContentLoaded', function() {
    // Appliquer la largeur des progress bars basÃ©e sur data-percentage
    document.querySelectorAll('.progress-bar[data-percentage]').forEach(function(bar) {
      const percentage = bar.getAttribute('data-percentage');
      bar.style.width = percentage + '%';
    });
  });
  /*]]>*/
</script>
